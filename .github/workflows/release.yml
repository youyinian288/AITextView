name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+-*'

jobs:
  validate-tag:
    name: éªŒè¯å‘å¸ƒæ ‡ç­¾
    runs-on: macos-14
    
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_prerelease: ${{ steps.check_prerelease.outputs.is_prerelease }}
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: èŽ·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
        
    - name: æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
      id: check_prerelease
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        if [[ $VERSION =~ -[a-zA-Z] ]]; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
          echo "è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬"
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "è¿™æ˜¯ä¸€ä¸ªæ­£å¼å‘å¸ƒç‰ˆæœ¬"
        fi
        
    - name: éªŒè¯Podspecç‰ˆæœ¬
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        PODSPEC_VERSION=$(grep 's.version' RichEditorView.podspec | sed 's/.*= "\(.*\)"/\1/')
        
        if [ "$VERSION" != "$PODSPEC_VERSION" ]; then
          echo "âŒ æ ‡ç­¾ç‰ˆæœ¬ ($VERSION) ä¸Ž Podspec ç‰ˆæœ¬ ($PODSPEC_VERSION) ä¸åŒ¹é…"
          exit 1
        fi
        echo "âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: $VERSION"

  build-and-test:
    name: æž„å»ºå’Œæµ‹è¯•
    runs-on: macos-14
    needs: validate-tag
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: é€‰æ‹©Xcodeç‰ˆæœ¬
      run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
      
    - name: è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
      run: |
        # Swift Package Manager æž„å»º
        swift build
        swift test
        
        # æ¡†æž¶æž„å»ºå’Œæµ‹è¯•
        xcodebuild clean test \
          -project RichEditorView.xcodeproj \
          -scheme RichEditorView \
          -destination "platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
        
    - name: æž„å»ºå‘å¸ƒæ¡£æ¡ˆ
      run: |
        # åˆ›å»º XCFramework
        xcodebuild archive \
          -project RichEditorView.xcodeproj \
          -scheme RichEditorView \
          -destination "generic/platform=iOS" \
          -archivePath "build/RichEditorView-iOS.xcarchive" \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES
          
        xcodebuild archive \
          -project RichEditorView.xcodeproj \
          -scheme RichEditorView \
          -destination "generic/platform=iOS Simulator" \
          -archivePath "build/RichEditorView-iOS-Simulator.xcarchive" \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES
          
        xcodebuild -create-xcframework \
          -framework "build/RichEditorView-iOS.xcarchive/Products/Library/Frameworks/RichEditorView.framework" \
          -framework "build/RichEditorView-iOS-Simulator.xcarchive/Products/Library/Frameworks/RichEditorView.framework" \
          -output "build/RichEditorView.xcframework"
          
        # åŽ‹ç¼© XCFramework
        cd build
        zip -r RichEditorView-${{ needs.validate-tag.outputs.version }}.xcframework.zip RichEditorView.xcframework
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: RichEditorView-${{ needs.validate-tag.outputs.version }}
        path: build/RichEditorView-${{ needs.validate-tag.outputs.version }}.xcframework.zip

  deploy-cocoapods:
    name: å‘å¸ƒåˆ°CocoaPods
    runs-on: macos-14
    needs: [validate-tag, build-and-test]
    if: needs.validate-tag.outputs.is_prerelease == 'false'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        
    - name: å®‰è£…CocoaPods
      run: gem install cocoapods
      
    - name: éªŒè¯Podspec
      run: pod lib lint RichEditorView.podspec --allow-warnings
      
    - name: å‘å¸ƒåˆ°CocoaPods
      env:
        COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      run: |
        if [ -n "$COCOAPODS_TRUNK_TOKEN" ]; then
          pod trunk push RichEditorView.podspec --allow-warnings
          echo "âœ… æˆåŠŸå‘å¸ƒåˆ°CocoaPods"
        else
          echo "âš ï¸ æœªè®¾ç½® COCOAPODS_TRUNK_TOKENï¼Œè·³è¿‡CocoaPodså‘å¸ƒ"
        fi

  create-release:
    name: åˆ›å»ºGitHubå‘å¸ƒ
    runs-on: macos-14
    needs: [validate-tag, build-and-test]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v5
      with:
        name: RichEditorView-${{ needs.validate-tag.outputs.version }}
        path: artifacts/
        
    - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: changelog
      run: |
        # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^)
        
        echo "## ðŸš€ å‘å¸ƒå†…å®¹" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### âœ¨ æ–°åŠŸèƒ½å’Œæ”¹è¿›" >> CHANGELOG.md
        git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD --grep="feat\|add\|new" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ› é—®é¢˜ä¿®å¤" >> CHANGELOG.md
        git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD --grep="fix\|bug" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ“ å…¶ä»–å˜æ›´" >> CHANGELOG.md
        git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD --invert-grep --grep="feat\|add\|new\|fix\|bug" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ðŸ“¦ å®‰è£…æ–¹å¼" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "#### Swift Package Manager" >> CHANGELOG.md
        echo '```swift' >> CHANGELOG.md
        echo '.package(url: "https://github.com/T-Pro/RichEditorView", from: "${{ needs.validate-tag.outputs.version }}")' >> CHANGELOG.md
        echo '```' >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "#### CocoaPods" >> CHANGELOG.md
        echo '```ruby' >> CHANGELOG.md
        echo 'pod "RichEditorView", "~> ${{ needs.validate-tag.outputs.version }}"' >> CHANGELOG.md
        echo '```' >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "å®Œæ•´æ›´æ–°æ—¥å¿—: [æŸ¥çœ‹æ‰€æœ‰å˜æ›´](https://github.com/T-Pro/RichEditorView/compare/$PREVIOUS_TAG...${{ needs.validate-tag.outputs.version }})" >> CHANGELOG.md
        
    - name: åˆ›å»ºGitHubå‘å¸ƒ
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.validate-tag.outputs.version }}
        name: "RichEditorView ${{ needs.validate-tag.outputs.version }}"
        body_path: CHANGELOG.md
        prerelease: ${{ needs.validate-tag.outputs.is_prerelease == 'true' }}
        files: |
          artifacts/RichEditorView-${{ needs.validate-tag.outputs.version }}.xcframework.zip
        token: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: å‘å¸ƒæˆåŠŸé€šçŸ¥
    runs-on: macos-14
    needs: [validate-tag, build-and-test, create-release]
    if: always() && needs.build-and-test.result == 'success'
    
    steps:
    - name: å‘å¸ƒæˆåŠŸæ‘˜è¦
      run: |
        echo "## ðŸŽ‰ å‘å¸ƒæˆåŠŸ! " >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç‰ˆæœ¬:** ${{ needs.validate-tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**ç±»åž‹:** ${{ needs.validate-tag.outputs.is_prerelease == 'true' && 'é¢„å‘å¸ƒç‰ˆæœ¬' || 'æ­£å¼ç‰ˆæœ¬' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… å®Œæˆçš„ä»»åŠ¡:" >> $GITHUB_STEP_SUMMARY
        echo "- æž„å»ºå’Œæµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "- åˆ›å»º XCFramework" >> $GITHUB_STEP_SUMMARY
        echo "- åˆ›å»º GitHub å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.validate-tag.outputs.is_prerelease }}" == "false" ]; then
          echo "- å‘å¸ƒåˆ° CocoaPods" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **RichEditorView ${{ needs.validate-tag.outputs.version }} å·²æˆåŠŸå‘å¸ƒ!**" >> $GITHUB_STEP_SUMMARY
