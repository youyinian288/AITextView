name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  spm-build:
    name: Swift Package Manager Build
    runs-on: macos-14  # ä½¿ç”¨æ›´ç¨³å®šçš„macOSç‰ˆæœ¬
    strategy:
      matrix:
        ios: ['17.5', '16.4']
        include:
          - ios: '17.5'
            device: 'iPhone 15 Pro'
            xcode: '15.4'
          - ios: '16.4'
            device: 'iPhone 14 Pro'
            xcode: '15.2'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç¼“å­˜Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ matrix.ios }}-${{ hashFiles('Package.swift', 'Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-${{ matrix.ios }}-
          ${{ runner.os }}-spm-
      
    - name: é€‰æ‹©Xcodeç‰ˆæœ¬
      run: |
        # å°è¯•ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„Xcodeï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
        XCODE_PATH="/Applications/Xcode_${{ matrix.xcode }}.app/Contents/Developer"
        if [ -d "$XCODE_PATH" ]; then
          sudo xcode-select -s "$XCODE_PATH"
          echo "âœ… ä½¿ç”¨ Xcode ${{ matrix.xcode }}"
        else
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          echo "âš ï¸ ä½¿ç”¨é»˜è®¤ Xcode ç‰ˆæœ¬"
        fi
      
    - name: æ˜¾ç¤ºXcodeç‰ˆæœ¬
      run: xcodebuild -version
      
    - name: éªŒè¯Swift Package Manageræž„å»º
      run: |
        swift build
        swift test
        
    - name: æ£€æŸ¥åŒ…ç»“æž„
      run: swift package describe --type json

  framework-build:
    name: Framework Build & Test
    runs-on: macos-14
    strategy:
      matrix:
        destination: 
          - 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5'
          - 'platform=iOS Simulator,name=iPhone 14 Pro,OS=16.4'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç¼“å­˜Xcode DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-xcode-deriveddata-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-xcode-deriveddata-
      
    - name: é€‰æ‹©Xcodeç‰ˆæœ¬
      run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
      
    - name: æž„å»ºæ¡†æž¶
      run: |
        xcodebuild clean build \
          -project RichEditorView.xcodeproj \
          -scheme RichEditorView \
          -destination "${{ matrix.destination }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO
          
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        xcodebuild test \
          -project RichEditorView.xcodeproj \
          -scheme RichEditorView \
          -destination "${{ matrix.destination }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  sample-app-build:
    name: Sample App Build
    runs-on: macos-14
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: é€‰æ‹©Xcodeç‰ˆæœ¬
      run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
      
    - name: æž„å»ºSwiftUIç¤ºä¾‹åº”ç”¨
      run: |
        xcodebuild clean build \
          -project RichEditorViewSample/RichEditorViewSwiftUI/RichEditorViewSwiftUI.xcodeproj \
          -scheme RichEditorViewSwiftUI \
          -destination "platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
          
    - name: æž„å»ºUIKitç¤ºä¾‹åº”ç”¨
      run: |
        cd RichEditorViewSample/RichEditorViewUIKIT
        xcodebuild clean build \
          -workspace RichEditorViewSample.xcworkspace \
          -scheme RichEditorViewSample \
          -destination "platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  cocoapods-validation:
    name: CocoaPods Validation
    runs-on: macos-14
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true  # è‡ªåŠ¨ç¼“å­˜gemä¾èµ–
        
    - name: ç¼“å­˜CocoaPods
      uses: actions/cache@v4
      with:
        path: |
          ~/.cocoapods/repos
          ~/Library/Caches/CocoaPods
        key: ${{ runner.os }}-cocoapods-${{ hashFiles('RichEditorView.podspec') }}
        restore-keys: |
          ${{ runner.os }}-cocoapods-
        
    - name: å®‰è£…CocoaPods
      run: gem install cocoapods
      
    - name: éªŒè¯Podspec
      run: pod lib lint RichEditorView.podspec --allow-warnings --skip-import-validation
      
    - name: æ£€æŸ¥Podspecè¯­æ³•
      run: pod spec lint RichEditorView.podspec --allow-warnings --skip-import-validation

  code-quality:
    name: Code Quality Checks
    runs-on: macos-14
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: é€‰æ‹©Xcodeç‰ˆæœ¬
      run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
      
    - name: ç¼“å­˜Homebrew
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Homebrew
        key: ${{ runner.os }}-brew-swiftlint
        restore-keys: |
          ${{ runner.os }}-brew-
      
    - name: å®‰è£…SwiftLint
      run: |
        brew install swiftlint
        
    - name: è¿è¡ŒSwiftLint
      run: |
        swiftlint lint --reporter github-actions-logging
        
    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: |
        swiftlint lint --strict --reporter github-actions-logging || true

  security-scan:
    name: Security Scan
    runs-on: macos-14
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡ŒCodeQLåˆ†æž
      uses: github/codeql-action/init@v3
      with:
        languages: swift
        
    - name: æ‰§è¡ŒCodeQLåˆ†æž
      uses: github/codeql-action/analyze@v3

  documentation-check:
    name: Documentation Check
    runs-on: macos-14
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥READMEæ–‡ä»¶
      run: |
        if [ ! -f README.md ]; then
          echo "âŒ README.md ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… README.md å­˜åœ¨"
        
    - name: æ£€æŸ¥è®¸å¯è¯æ–‡ä»¶
      run: |
        if [ ! -f LICENSE.md ]; then
          echo "âŒ LICENSE.md ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… LICENSE.md å­˜åœ¨"
        
    - name: éªŒè¯åŒ…æ¸…å•
      run: |
        if [ ! -f Package.swift ]; then
          echo "âŒ Package.swift ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… Package.swift å­˜åœ¨"

  release-readiness:
    name: Release Readiness Check
    runs-on: macos-14
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    needs: [spm-build, framework-build, sample-app-build, cocoapods-validation, code-quality]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
      run: |
        # ä»ŽPackage.swiftèŽ·å–ç‰ˆæœ¬ï¼ˆå¦‚æžœæœ‰çš„è¯ï¼‰
        # ä»ŽPodspecèŽ·å–ç‰ˆæœ¬
        PODSPEC_VERSION=$(grep 's.version' RichEditorView.podspec | sed 's/.*= "\(.*\)"/\1/')
        echo "Podspecç‰ˆæœ¬: $PODSPEC_VERSION"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç‰ˆæœ¬æ ‡ç­¾
        if git tag -l | grep -q "^$PODSPEC_VERSION$"; then
          echo "âœ… ç‰ˆæœ¬æ ‡ç­¾ $PODSPEC_VERSION å·²å­˜åœ¨"
        else
          echo "âš ï¸ ç‰ˆæœ¬æ ‡ç­¾ $PODSPEC_VERSION ä¸å­˜åœ¨"
        fi
        
    - name: ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š
      run: |
        echo "## ðŸš€ å‘å¸ƒå°±ç»ªæ€§æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Swift Package Manager æž„å»ºé€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ¡†æž¶æž„å»ºå’Œæµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç¤ºä¾‹åº”ç”¨æž„å»ºé€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… CocoaPods éªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **é¡¹ç›®å·²å‡†å¤‡å¥½å‘å¸ƒ!**" >> $GITHUB_STEP_SUMMARY
